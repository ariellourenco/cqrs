# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '.vscode/*'
      - '**/*.md'
      - '**/*.editorconfig'
      - '**/*.gitignore'
      - '**/*.gitattributes'
  pull_request:
    branches: [ main ]

env:
  BUILD_ARTIFACTS: ${{ github.workspace }}/artifacts
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: 1

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Install .NET Core SDK
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.0.x

    # Restore dependencies and tools.
    - name: Restore Dependencies
      run: dotnet restore

    # Enforce code style preferences to the project.
    # By default, preferences will be read from an .editorconfig file, if present, otherwise a default set will be used.
    # The task ensure the exit code is 0. If a file needs to be edited by dotnet format,
    # the exit code will be a non-zero value and the task will fail.
    # ðŸ“š https://github.com/actions/toolkit/blob/master/docs/problem-matchers.md#problem-matchers
    - run: echo "::add-matcher::$GITHUB_WORKSPACE/.github/matchers/dotnet-format.json"
    - run: dotnet format Conference.slnx --no-restore --verify-no-changes --verbosity diagnostic

    # Attempts to build and correlate generated assemblies with the commit.
    - name: Build
      run: dotnet build --configuration Release --no-restore --nologo /p:ContinuousIntegrationBuild=true /p:SourceRevisionId=${{ github.sha }}

    # ðŸ§ª Run tests (unit, integration and functional tests)
    # using the new Microsoft Testing Platform.
    - name: Run Tests
      run: >-
        dotnet test --configuration Release --coverage --coverage-output-format cobertura --no-build --no-restore
        --results-directory ${{ env.BUILD_ARTIFACTS }}/test-results
        --report-trx

    # Upload coverage report to Codecov.
    - name: Upload Coverage
      uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 #v5.5.1
      with:
        fail_ci_if_error: true
        files: ${{ env.BUILD_ARTIFACTS }}/test-results/*.cobertura.xml
        flags: unittests # optional
        name: codecov-umbrella # optional
        token: ${{ secrets.CODECOV_TOKEN }}
        verbose: false
